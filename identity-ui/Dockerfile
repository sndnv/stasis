ARG SERVICE_PATH=/opt/stasis-identity-ui

FROM node:16.14-alpine as dev-stage
ARG SERVICE_PATH
WORKDIR ${SERVICE_PATH}
COPY package.json ./
RUN yarn install
COPY . .

FROM dev-stage as build-stage
ARG SERVICE_PATH
WORKDIR ${SERVICE_PATH}
COPY --from=dev-stage ${SERVICE_PATH} ${SERVICE_PATH}

ARG VUE_APP_STASIS_IDENTITY_UI_API_URL
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_CLIENT_ID
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_REDIRECT_URI
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_STATE_SIZE
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_VERIFIER_SIZE
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_DERIVATION_ENABLED
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_DERIVATION_SALT
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_DERIVATION_ITERATIONS
ARG VUE_APP_STASIS_IDENTITY_UI_AUTH_DERIVATION_KEY_SIZE

RUN apk add gettext
RUN envsubst < .env.template > .env.production

RUN yarn build

FROM nginx:stable-alpine as production-stage
ARG SERVICE_PATH
WORKDIR ${SERVICE_PATH}
COPY --from=build-stage ${SERVICE_PATH}/dist /usr/share/nginx/html

ARG NGINX_SERVER_NAME
ARG NGINX_SERVER_PORT
ARG NGINX_CORS_ALLOWED_ORIGIN

COPY nginx.template ./
RUN envsubst \$NGINX_SERVER_NAME,\$NGINX_SERVER_PORT,\$NGINX_CORS_ALLOWED_ORIGIN < nginx.template > /etc/nginx/nginx.conf
