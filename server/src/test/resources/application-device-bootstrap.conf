pekko {
  loglevel = "INFO"
  loggers = ["org.apache.pekko.event.Logging$DefaultLogger"]
  logging-filter = "org.apache.pekko.event.DefaultLoggingFilter"

  test {
    timefactor = 15.0
  }
}

stasis {
  server {
    service {
      internal-query-timeout = 3 seconds

      api {
        interface = "localhost"
        port = 28999
        context {
          enabled = true
          type = "server"
          protocol = "TLS"
          keystore {
            path = "./core/src/test/resources/certs/localhost.p12"
            type = "PKCS12"
            password = ""
          }
        }
      }

      core {
        interface = "localhost"
        port = 38999
        context {
          enabled = true
          type = "server"
          protocol = "TLS"
          keystore {
            path = "./core/src/test/resources/certs/localhost.p12"
            type = "PKCS12"
            password = ""
          }
        }
      }

      bootstrap {
        mode = init-and-start
        config = "bootstrap-integration.conf"
      }

      discovery {
        type = "disabled"

        static {
          config = ""
        }
      }

      telemetry {
        metrics {
          interface = "localhost"
          port = 58999

          context {
            enabled = false
            type = "server"
            protocol = "TLS"

            keystore {
              path = ""
              type = "PKCS12"
              password = ""
            }
          }
        }
      }
    }

    authenticators {
      users {
        issuer = "stasis-identity-test"
        audience = "stasis-server-test"
        identity-claim = "sub"
        jwks-endpoint = "http://localhost:28998/valid/jwks.json"
        refresh-interval = 90 minutes
        refresh-retry-interval = 3 seconds
        expiration-tolerance = 30 seconds

        context {
          enabled = true
          type = "client"
          protocol = "TLS"

          truststore {
            path = "./core/src/test/resources/certs/localhost.p12"
            type = "PKCS12"
            password = ""
          }
        }
      }

      nodes {
        issuer = "stasis-identity-test"
        audience = "stasis-server-test"
        identity-claim = "sub"
        jwks-endpoint = "http://localhost:28998/valid/jwks.json"
        refresh-interval = 90 minutes
        refresh-retry-interval = 3 seconds
        expiration-tolerance = 30 seconds

        context {
          enabled = true
          type = "client"
          protocol = "TLS"

          truststore {
            path = "./core/src/test/resources/certs/localhost.p12"
            type = "PKCS12"
            password = ""
          }
        }
      }

      instance {
        token-endpoint = "http://localhost:28998/oauth/token"
        client-id = "39f7263e-77dd-4019-afcc-3e05d623aca8"
        client-secret = "some-secret"
        expiration-tolerance = 30 seconds
        use-query-string = false

        context {
          enabled = true
          type = "client"
          protocol = "TLS"

          truststore {
            path = "./core/src/test/resources/certs/localhost.p12"
            type = "PKCS12"
            password = ""
          }
        }
      }
    }

    credentials-managers {
      type = "identity"

      identity {
        url = "http://localhost:28997"

        management {
          user = "test-user"
          user-password = "test-password"
          scope = "manage:clients"
          token-expiration-tolerance = 10 seconds
        }

        client {
          redirect-uri = "https://localhost:9999"
          token-expiration = 90 minutes
        }

        context {
          enabled = false
          type = "client"
          protocol = "TLS"

          truststore {
            path = ""
            type = "PKCS12"
            password = ""
          }
        }
      }
    }

    routing {
      router {
        type = "default"

        default {
          id = "03657d9f-96de-4dae-8e34-2fa989ebe6da"

          clients {
            authentication {
              token-expiration-tolerance = 30 seconds
            }

            core {
              max-chunk-size = 8192

              http {
                request-buffer-size = 100

                retry {
                  min-backoff = 500 millis
                  max-backoff = 3 seconds
                  random-factor = 0.1
                  max-retries = 5
                }
              }

              context {
                enabled = true
                type = "client"
                protocol = "TLS"

                truststore {
                  path = "./core/src/test/resources/certs/localhost.p12"
                  type = "PKCS12"
                  password = ""
                }
              }
            }
          }
        }
      }
    }

    persistence {
      database {
        profile = "H2Profile"
        url = "jdbc:h2:mem:server-integration"
        driver = "org.h2.Driver"
        user = ""
        password = ""
        keep-alive-connection = true
      }

      reservations {
        expiration = 1 minute
      }

      users {
        salt-size = 8
      }

      staging {
        enabled = false
        destaging-delay = 1 minute
        store {
          type = "memory"
          memory {
            max-size = 100M
            max-chunk-size = 8K
            name = "test-memory-store"
          }
        }
      }
    }

    bootstrap {
      api {
        interface = ${stasis.server.service.api.interface}
        port = 48999

        context {
          enabled = ${stasis.server.service.api.context.enabled}
          type = ${stasis.server.service.api.context.type}
          protocol = ${stasis.server.service.api.context.protocol}

          keystore {
            path = ${stasis.server.service.api.context.keystore.path}
            type = ${stasis.server.service.api.context.keystore.type}
            password = ${stasis.server.service.api.context.keystore.password}
          }
        }
      }

      devices {
        code-size = 9
        code-expiration = 5 minutes

        secret-size = 24

        parameters {
          authentication {
            token-endpoint = ${stasis.server.authenticators.instance.token-endpoint}
            use-query-string = ${stasis.server.authenticators.instance.use-query-string}

            scopes {
              api = "urn:stasis:identity:audience:"${stasis.server.authenticators.users.audience}
              core = "urn:stasis:identity:audience:"${stasis.server.authenticators.nodes.audience}
            }

            context {
              enabled = ${stasis.server.authenticators.instance.context.enabled}
              protocol = ${stasis.server.authenticators.instance.context.protocol}

              truststore {
                path = ${stasis.server.authenticators.instance.context.truststore.path}
                type = ${stasis.server.authenticators.instance.context.truststore.type}
                password = ${stasis.server.authenticators.instance.context.truststore.password}
              }
            }
          }

          server-api {
            url = "https://localhost:"${stasis.server.service.api.port}

            context {
              enabled = false
              protocol = ${stasis.server.service.api.context.protocol}

              truststore {
                path = ${stasis.server.service.api.context.keystore.path}
                type = ${stasis.server.service.api.context.keystore.type}
                password = ${stasis.server.service.api.context.keystore.password}
              }
            }
          }

          server-core {
            address = "https://localhost:"${stasis.server.service.core.port}

            context {
              enabled = false
              protocol = ${stasis.server.service.core.context.protocol}

              truststore {
                path = ${stasis.server.service.core.context.keystore.path}
                type = ${stasis.server.service.core.context.keystore.type}
                password = ${stasis.server.service.core.context.keystore.password}
              }
            }
          }

          secrets {
            derivation {
              encryption {
                secret-size = 32
                iterations = 150000
                salt-prefix = "changeme"
              }

              authentication {
                enabled = true
                secret-size = 16
                iterations = 150000
                salt-prefix = "changeme"
              }
            }

            encryption {
              file {
                key-size = 16
              }

              metadata {
                key-size = 16
              }

              device-secret {
                key-size = 16
              }
            }
          }

          additional-config = "bootstrap-device-additional-config"
        }
      }
    }

    events {
      collector {
        type = "noop"
      }
    }

    actions {
      executor {
        type = "noop"
      }

      config = ""
    }
  }
}
